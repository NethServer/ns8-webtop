#!/bin/bash

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

#Expand Autoconfiguration Template



#Exit immediately if a command exits with a non-zero status.
set -e 

# Wait for MAIL_DOMAIN and WEBTOP_HOSTNAME to be set (timeout after 30s)
for i in {1..15}; do
    if [[ -n "$MAIL_DOMAIN" && -n "$WEBTOP_HOSTNAME" ]]; then
        break
    fi
    echo "Waiting for MAIL_DOMAIN and WEBTOP_HOSTNAME to be set..."
    sleep 2
done

if [[ -z "$MAIL_DOMAIN" ]]; then
    echo "MAIL_DOMAIN variable is not set"
    exit 1
fi

if [[ -z "$WEBTOP_HOSTNAME" ]]; then
    echo "WEBTOP_HOSTNAME variable is not set"
    exit 1
fi

mkdir -p {autoconfiguration,vhosts}


# thunderbird autoconfiguration
INPUT_FILE="../templates/autoconfiguration/config-v1.1.xml"
OUTPUT_FILE="./autoconfiguration/config-v1.1.xml"
sed "s/{{ domain }}/$MAIL_DOMAIN/g" "$INPUT_FILE" > "$OUTPUT_FILE"

# outlook autoconfiguration
INPUT_FILE="../templates/autoconfiguration/autodiscover.xml"
OUTPUT_FILE="./autoconfiguration/autodiscover.xml"
sed "s/{{ domain }}/$MAIL_DOMAIN/g" "$INPUT_FILE" > "$OUTPUT_FILE"

# index.html for Let's Encrypt requirements
# This file is used to verify the domain ownership for Let's Encrypt SSL certificate generation.
INPUT_FILE="../templates/autoconfiguration/index.html"
OUTPUT_FILE="./autoconfiguration/index.html"
sed "s/{{ domain }}/$MAIL_DOMAIN/g" "$INPUT_FILE" > "$OUTPUT_FILE"

# vhost of apache container
INPUT_FILE="../templates/autoconfiguration/autoconfiguration.conf"
OUTPUT_FILE="./vhosts/autoconfiguration.conf"
sed "s/{{ domain }}/$MAIL_DOMAIN/g" "$INPUT_FILE" > "$OUTPUT_FILE"

# webapp configuration
INPUT_FILE="../templates/autoconfiguration/webapp.conf"
OUTPUT_FILE="./vhosts/webapp.conf"
sed "s/{{ webtop_hostname }}/$WEBTOP_HOSTNAME/g" "$INPUT_FILE" > "$OUTPUT_FILE"
