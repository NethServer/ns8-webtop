#!/bin/bash

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

#Expand Autoconfiguration Template



#Exit immediately if a command exits with a non-zero status.
set -e 

# Wait for MAIL_DOMAIN to be set (timeout after 30s)
for i in {1..15}; do
    if [[ -n "$MAIL_DOMAIN" ]]; then
        break
    fi
    echo "Waiting for MAIL_DOMAIN to be set..."
    sleep 2
done

if [[ -z "$MAIL_DOMAIN" ]]; then
    echo "MAIL_DOMAIN variable is not set"
    exit 1
fi

mkdir -p autoconfiguration


# thunderbird autoconfiguration
INPUT_FILE="../templates/autoconfiguration/config-v1.1.xml"
OUTPUT_FILE="./autoconfiguration/config-v1.1.xml"
sed "s/{{ domain }}/$MAIL_DOMAIN/g" "$INPUT_FILE" > "$OUTPUT_FILE"

# outlook autoconfiguration
INPUT_FILE="../templates/autoconfiguration/autodiscover.xml"
OUTPUT_FILE="./autoconfiguration/autodiscover.xml"
sed "s/{{ domain }}/$MAIL_DOMAIN/g" "$INPUT_FILE" > "$OUTPUT_FILE"
